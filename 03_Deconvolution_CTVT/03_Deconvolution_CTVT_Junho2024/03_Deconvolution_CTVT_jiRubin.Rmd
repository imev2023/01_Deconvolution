---
title: "03_Deconvolution_CTVT_Junho2024"
output: html_document
---

# 0 Environment
## 0.1 Packages
### 0.1.1 Installs
### 0.1.1 Library
```{r echo=F, message=F, warning=FALSE}
set.seed(123)
library(tidyverse)
library(openxlsx)
library(SingleCellExperiment)
setClassUnion("ExpData", c("matrix", "SummarizedExperiment"))
library(DGEobj.utils)
library(optparse)
library(dplyr)
library(Biobase)
library(ggpattern)
library(ggnewscale)
library(Seurat)
library(zellkonverter)
library(dplyr)
```

## 0.2 Paths
```{r echo=F, message=FALSE, warning=FALSE}
wDir <- paste0("~/gitClones/01_Deconvolution/03_Deconvolution_CTVT/")
fprefix <- "03_Deconvolution_CTVT_jiRubin"
dataDir <- paste0(wDir, "/031_Data/")
resDir <- paste0(wDir, "/033_Results/", fprefix, "/")
plotDir <- paste0(wDir, "/034_Plots/", fprefix, "/")

dir.create(resDir)
dir.create(plotDir)
```

# 1 Human Data
## 1.1 Raw data
### 1.1.1 Read in data from Junho 2024 atlas. 
+ We can recover these cell types from other datasets too. 
- Not raw data, so checking if we can map the cell id's from the original paper to the Junho annotation. 
```{r}
temp <- readH5AD(paste0(dataDir, "GSE144236/skin_GSE144236.h5ad"))
coldataJunho <- colData(temp) %>% as.data.frame()
rm(temp)
gc()
# assay(temp, "counts") <- as.matrix(assay(temp, "X"))
#   # Files have already been processed! --> log counts
# assay(temp, "logcounts") <- as.matrix(assay(temp, "X"))
# temp <- as.Seurat(temp)
# temp@meta.data <- coldata %>% as.data.frame()
#   # > table(temp$Celltype)
#   # B cell Dendritic cell    Endothelial     Epithelial     Fibroblast     Macrophage           Mast        NK cell    Plasma cell         T cell 
#   # 141           4339            444          29802            900           9396             23            223            102           1480 
#   # pDC 
#   # 266 --> proportions from Junho et al paper.? 
# # }
# gc() 
```
### 1.1.2 Read in data from original paper.
Original paper had 48,164 cells. 
In Junho, there are only annotations from 47,116 cells. 

Metadata of original paper: where the tumor came from
Keep only tumor samples!
How to separate tumor cells from host TME cells? Remove epithelial cluster completely?
```{r}
meta <- read.delim(paste0(dataDir, "GSE144236/GSE144236_patient_metadata_new.txt")) %>%
  as.data.frame()

table(meta$tum.norm)
table(meta$patient)
table(meta$level1_celltype)
# counts <- read.delim(paste0(dataDir, "GSE144236/GSE144236_cSCC_counts.txt"))

metaTumor <- meta %>%
  filter(tum.norm=="Tumor")
# table(metaTumor$level1_celltype)
#             ASDC           B Cell             CD1C           CLEC9A Endothelial Cell       Epithelial       Fibroblast               LC              Mac 
#              319              250             3615              719              194            12651              647             2341             2370 
#             MDSC       Melanocyte        Multiplet               NK              PDC            Tcell 
#              347              530              793              112              248             1163 

metaHost <- meta %>%
  filter(tum.norm != "Tumor")
table(metaHost$level1_celltype)
            # ASDC           B Cell             CD1C           CLEC9A Endothelial Cell       Epithelial       Fibroblast               LC              Mac 
            #   26                6             1298              146              258            16179              235             1461              815 
            # MDSC       Melanocyte        Multiplet               NK              PDC            Tcell 
            #  378              266              303               27                6              461 

counts <-  read.delim(paste0(dataDir, "GSE144236/GSE144236_cSCC_counts.txt"))

human <- CreateSeuratObject(counts = counts,
                            meta.data = meta)
```


## 1.3 Mapping genes
Read in file from ~/gitClones/01_Deconvolution/03_Deconvolution_CTVT/032_Scripts/03_Deconvolution_CTVT_customScaden/03_Deconvolution_CTVT_orthologs.R. 
This maps unique genes between the skin and CTVT datasets. 
